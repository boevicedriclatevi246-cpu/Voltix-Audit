{% extends "base.html" %}

{% block title %}Comparer des projets - Voltix Audit{% endblock %}

{% block content %}
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="{{ url_for('accueil') }}">
            <i class="fas fa-bolt"></i> Voltix Audit
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('accueil') }}">
                        <i class="fas fa-home"></i> Accueil
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('liste_projets') }}">
                        <i class="fas fa-folder"></i> Projets
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="{{ url_for('comparer_projets') }}">
                        <i class="fas fa-balance-scale"></i> Comparer
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('tarifs') }}">
                        <i class="fas fa-tag"></i> Tarifs
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('mon_compte') }}">
                        <i class="fas fa-user"></i> Mon compte
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('deconnexion') }}">
                        <i class="fas fa-sign-out-alt"></i> Déconnexion
                    </a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4 mb-5">

    <!-- Messages Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- En-tête -->
    <div class="text-center mb-4">
        <h2 class="fw-bold">
            <i class="fas fa-balance-scale"></i> Comparaison de projets
        </h2>
        <p class="text-muted">
            <i class="fas fa-crown"></i> Fonctionnalité réservée aux utilisateurs Pro
        </p>
    </div>

    {% if not comparaison %}
        <!-- Formulaire de sélection -->
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow-lg">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-4">
                            <i class="fas fa-sliders-h"></i> Sélectionnez 2 projets à comparer
                        </h5>

                        <form method="POST" action="{{ url_for('comparer_projets') }}">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-folder"></i> Projet A
                                    </label>
                                    <select name="projet_a_id" class="form-select" required>
                                        <option value="">-- Sélectionner un projet --</option>
                                        {% for projet in projets_audites %}
                                            <option value="{{ projet.id }}">{{ projet.nom_projet }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-folder"></i> Projet B
                                    </label>
                                    <select name="projet_b_id" class="form-select" required>
                                        <option value="">-- Sélectionner un projet --</option>
                                        {% for projet in projets_audites %}
                                            <option value="{{ projet.id }}">{{ projet.nom_projet }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="alert alert-info" role="alert">
                                <i class="fas fa-info-circle"></i>
                                <strong>Note :</strong> Seuls les projets ayant un audit calculé apparaissent dans la liste.
                            </div>

                            <div class="text-center">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-chart-bar"></i> Comparer
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    {% else %}
        <!-- Résultats de la comparaison -->
        <div class="row mb-4">
            <div class="col-12">
                <a href="{{ url_for('comparer_projets') }}" class="btn btn-secondary mb-3">
                    <i class="fas fa-arrow-left"></i> Nouvelle comparaison
                </a>
            </div>
        </div>

        <!-- En-têtes des projets -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="card shadow-sm border-primary">
                    <div class="card-body text-center">
                        <h4 class="fw-bold text-primary">
                            <i class="fas fa-folder"></i> {{ comparaison.projet_a.nom_projet }}
                        </h4>
                        <p class="text-muted mb-0">{{ comparaison.projet_a.client_nom }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card shadow-sm border-success">
                    <div class="card-body text-center">
                        <h4 class="fw-bold text-success">
                            <i class="fas fa-folder"></i> {{ comparaison.projet_b.nom_projet }}
                        </h4>
                        <p class="text-muted mb-0">{{ comparaison.projet_b.client_nom }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tableau comparatif -->
        <div class="card shadow-lg mb-4">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 40%;">Indicateur</th>
                                <th class="text-center" style="width: 30%; background-color: rgba(13, 110, 253, 0.1);">
                                    {{ comparaison.projet_a.nom_projet }}
                                </th>
                                <th class="text-center" style="width: 30%; background-color: rgba(25, 135, 84, 0.1);">
                                    {{ comparaison.projet_b.nom_projet }}
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Classe énergétique -->
                            <tr>
                                <td class="fw-bold">
                                    <i class="fas fa-certificate"></i> Classe énergétique
                                </td>
                                <td class="text-center">
                                    <span class="badge fs-5" style="background-color: {{ comparaison.classe_a_couleur }}; color: white;">
                                        {{ comparaison.resultat_a.classe_energetique }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="badge fs-5" style="background-color: {{ comparaison.classe_b_couleur }}; color: white;">
                                        {{ comparaison.resultat_b.classe_energetique }}
                                    </span>
                                </td>
                            </tr>

                            <!-- Consommation -->
                            <tr>
                                <td class="fw-bold">
                                    <i class="fas fa-bolt"></i> Consommation annuelle
                                </td>
                                <td class="text-center {% if comparaison.resultat_a.consommation_annuelle_kwh < comparaison.resultat_b.consommation_annuelle_kwh %}text-success fw-bold{% endif %}">
                                    {{ "{:,.0f}".format(comparaison.resultat_a.consommation_annuelle_kwh) }} kWh/an
                                    {% if comparaison.resultat_a.consommation_annuelle_kwh < comparaison.resultat_b.consommation_annuelle_kwh %}
                                        <i class="fas fa-arrow-down text-success"></i>
                                    {% endif %}
                                </td>
                                <td class="text-center {% if comparaison.resultat_b.consommation_annuelle_kwh < comparaison.resultat_a.consommation_annuelle_kwh %}text-success fw-bold{% endif %}">
                                    {{ "{:,.0f}".format(comparaison.resultat_b.consommation_annuelle_kwh) }} kWh/an
                                    {% if comparaison.resultat_b.consommation_annuelle_kwh < comparaison.resultat_a.consommation_annuelle_kwh %}
                                        <i class="fas fa-arrow-down text-success"></i>
                                    {% endif %}
                                </td>
                            </tr>

                            <!-- Émissions CO2 -->
                            <tr>
                                <td class="fw-bold">
                                    <i class="fas fa-cloud"></i> Émissions CO₂
                                </td>
                                <td class="text-center {% if comparaison.resultat_a.emissions_co2_kg_an < comparaison.resultat_b.emissions_co2_kg_an %}text-success fw-bold{% endif %}">
                                    {{ "{:,.0f}".format(comparaison.resultat_a.emissions_co2_kg_an) }} kg/an
                                    {% if comparaison.resultat_a.emissions_co2_kg_an < comparaison.resultat_b.emissions_co2_kg_an %}
                                        <i class="fas fa-arrow-down text-success"></i>
                                    {% endif %}
                                </td>
                                <td class="text-center {% if comparaison.resultat_b.emissions_co2_kg_an < comparaison.resultat_a.emissions_co2_kg_an %}text-success fw-bold{% endif %}">
                                    {{ "{:,.0f}".format(comparaison.resultat_b.emissions_co2_kg_an) }} kg/an
                                    {% if comparaison.resultat_b.emissions_co2_kg_an < comparaison.resultat_a.emissions_co2_kg_an %}
                                        <i class="fas fa-arrow-down text-success"></i>
                                    {% endif %}
                                </td>
                            </tr>

                            <!-- Coût annuel -->
                            <tr>
                                <td class="fw-bold">
                                    <i class="fas fa-money-bill-wave"></i> Coût annuel
                                </td>
                                <td class="text-center {% if comparaison.resultat_a.cout_annuel_fcfa < comparaison.resultat_b.cout_annuel_fcfa %}text-success fw-bold{% endif %}">
                                    {{ "{:,.0f}".format(comparaison.resultat_a.cout_annuel_fcfa) }} FCFA/an
                                    {% if comparaison.resultat_a.cout_annuel_fcfa < comparaison.resultat_b.cout_annuel_fcfa %}
                                        <i class="fas fa-arrow-down text-success"></i>
                                    {% endif %}
                                </td>
                                <td class="text-center {% if comparaison.resultat_b.cout_annuel_fcfa < comparaison.resultat_a.cout_annuel_fcfa %}text-success fw-bold{% endif %}">
                                    {{ "{:,.0f}".format(comparaison.resultat_b.cout_annuel_fcfa) }} FCFA/an
                                    {% if comparaison.resultat_b.cout_annuel_fcfa < comparaison.resultat_a.cout_annuel_fcfa %}
                                        <i class="fas fa-arrow-down text-success"></i>
                                    {% endif %}
                                </td>
                            </tr>

                            <!-- Score -->
                            <tr>
                                <td class="fw-bold">
                                    <i class="fas fa-star"></i> Score de performance
                                </td>
                                <td class="text-center {% if comparaison.resultat_a.score_performance > comparaison.resultat_b.score_performance %}text-success fw-bold{% endif %}">
                                    {{ comparaison.resultat_a.score_performance }}/100
                                    {% if comparaison.resultat_a.score_performance > comparaison.resultat_b.score_performance %}
                                        <i class="fas fa-arrow-up text-success"></i>
                                    {% endif %}
                                </td>
                                <td class="text-center {% if comparaison.resultat_b.score_performance > comparaison.resultat_a.score_performance %}text-success fw-bold{% endif %}">
                                    {{ comparaison.resultat_b.score_performance }}/100
                                    {% if comparaison.resultat_b.score_performance > comparaison.resultat_a.score_performance %}
                                        <i class="fas fa-arrow-up text-success"></i>
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Analyse -->
        <div class="row">
            <div class="col-lg-12">
                <div class="card shadow-lg">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-lightbulb"></i> Analyse comparative
                        </h5>

                        <div class="alert {{ 'alert-primary' if comparaison.meilleur == 'a' else 'alert-success' }}" role="alert">
                            <h6 class="alert-heading">
                                <i class="fas fa-trophy"></i> Projet le plus performant :
                                <strong>{{ comparaison.projet_a.nom_projet if comparaison.meilleur == 'a' else comparaison.projet_b.nom_projet }}</strong>
                            </h6>
                            <hr>
                            <p class="mb-0">
                                Ce projet a une meilleure classe énergétique et consomme moins d'énergie.
                            </p>
                        </div>

                        <h6 class="fw-bold mt-4 mb-3">Différences clés :</h6>
                        <ul>
                            <li>
                                <strong>Consommation :</strong>
                                Écart de {{ "{:,.0f}".format(comparaison.diff_conso|abs) }} kWh/an
                                ({{ "{:.1f}".format(comparaison.diff_conso_pct) }}%)
                            </li>
                            <li>
                                <strong>Coût :</strong>
                                Écart de {{ "{:,.0f}".format(comparaison.diff_cout|abs) }} FCFA/an
                                ({{ "{:.1f}".format(comparaison.diff_cout_pct) }}%)
                            </li>
                            <li>
                                <strong>CO₂ :</strong>
                                Écart de {{ "{:,.0f}".format(comparaison.diff_co2|abs) }} kg/an
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

</div>
{% endblock %}

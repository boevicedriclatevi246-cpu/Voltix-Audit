{% extends "base.html" %}

{% block title %}{{ projet.nom_projet }} - Voltix Audit{% endblock %}

{% block content %}
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="{{ url_for('accueil') }}">
            <i class="fas fa-bolt"></i> Voltix Audit
        </a>
    </div>
</nav>

<div class="container mt-4 mb-5">

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('accueil') }}">Accueil</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('liste_projets') }}">Projets</a></li>
            <li class="breadcrumb-item active">{{ projet.nom_projet }}</li>
        </ol>
    </nav>

    <!-- Messages Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- En-t√™te projet -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="mb-2">{{ projet.nom_projet }}</h2>
            <p class="text-muted mb-0">
                <i class="fas fa-building"></i> {{ projet.client_nom }} ‚Ä¢ {{ projet.type_batiment }}
            </p>
        </div>
        <div class="col-md-4 text-md-end">
            <span class="badge bg-{{ 'success' if projet.statut == 'termine' else 'warning' }} fs-6">
                {{ projet.statut|replace('_', ' ')|capitalize }}
            </span>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body">
                    <i class="fas fa-layer-group fa-2x text-primary mb-2"></i>
                    <h4 class="mb-0">{{ stats.nb_etages if stats else 0 }}</h4>
                    <small class="text-muted">√âtages</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body">
                    <i class="fas fa-door-open fa-2x text-info mb-2"></i>
                    <h4 class="mb-0">{{ stats.nb_pieces if stats else 0 }}</h4>
                    <small class="text-muted">Pi√®ces</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body">
                    <i class="fas fa-plug fa-2x text-warning mb-2"></i>
                    <h4 class="mb-0">{{ stats.nb_equipements if stats else 0 }}</h4>
                    <small class="text-muted">√âquipements</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body">
                    <i class="fas fa-percentage fa-2x text-success mb-2"></i>
                    <h4 class="mb-0">{{ projet.pourcentage_completion }}%</h4>
                    <small class="text-muted">Compl√©tion</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions principales -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-rocket"></i> Actions rapides
                    </h5>
                    <div class="row">
                        <!-- Ajouter un √©tage -->
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('nouvel_etage', projet_id=projet.id) }}" class="btn btn-primary w-100">
                                <i class="fas fa-plus"></i> Ajouter un √©tage
                            </a>
                        </div>

                        <!-- Calculer l'audit avec compteur -->
                        <div class="col-md-3 mb-2">
                            <form method="POST" action="{{ url_for('calculer_audit', projet_id=projet.id) }}" class="d-inline w-100">
                                <button type="submit" class="btn btn-success w-100"
                                        {% if not stats or stats.nb_equipements == 0 %}disabled title="Ajoutez des √©quipements d'abord"{% endif %}>
                                    <i class="fas fa-calculator"></i> Calculer l'audit
                                </button>
                            </form>
                            <small class="text-muted d-block mt-1 text-center">
                                <i class="fas fa-info-circle"></i>
                                {{ current_user.audits_max_mois - current_user.audits_utilises_ce_mois }} audit(s) restant(s)
                            </small>
                        </div>

                        <!-- Voir les r√©sultats -->
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('resultats_audit', projet_id=projet.id) }}" class="btn btn-info w-100">
                                <i class="fas fa-chart-line"></i> Voir les r√©sultats
                            </a>
                        </div>

                        <!-- Retour projets -->
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('liste_projets') }}" class="btn btn-secondary w-100">
                                <i class="fas fa-arrow-left"></i> Retour projets
                            </a>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="alert alert-info mt-3" role="alert">
                        <strong>üìù Guide rapide :</strong>
                        <ol class="mb-0 mt-2">
                            <li>Ajoutez des √©tages √† votre b√¢timent</li>
                            <li>Pour chaque √©tage, ajoutez des pi√®ces</li>
                            <li>Pour chaque pi√®ce, ajoutez des √©quipements</li>
                            <li>Cliquez sur "Calculer l'audit" pour obtenir les r√©sultats</li>
                            <li>Consultez les r√©sultats et t√©l√©chargez le rapport PDF</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des √©tages -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-layer-group"></i> √âtages du b√¢timent
                    </h5>

                    {% if etages %}
                        <div class="list-group">
                            {% for etage in etages %}
                            <a href="{{ url_for('detail_etage', projet_id=projet.id, etage_id=etage.id) }}"
                               class="list-group-item list-group-item-action">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">
                                            <i class="fas fa-building"></i> {{ etage.nom_etage }}
                                        </h6>
                                        <small class="text-muted">
                                            {{ etage.pieces_count or 0 }} pi√®ce(s) ‚Ä¢
                                            {{ etage.surface_etage or 0 }} m¬≤ ‚Ä¢
                                            {{ etage.equipements_count or 0 }} √©quipement(s)
                                        </small>
                                    </div>
                                    <div>
                                        {% if etage.equipements_count and etage.equipements_count > 0 %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check"></i> Complet
                                            </span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-exclamation"></i> Incomplet
                                            </span>
                                        {% endif %}
                                        <i class="fas fa-chevron-right ms-2"></i>
                                    </div>
                                </div>
                            </a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-layer-group fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Aucun √©tage cr√©√©</p>
                            <a href="{{ url_for('nouvel_etage', projet_id=projet.id) }}" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Ajouter le premier √©tage
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}
